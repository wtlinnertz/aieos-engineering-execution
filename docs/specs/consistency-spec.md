# Consistency Specification

The consistency check verifies that intent, requirements, constraints, and scope flow consistently from upstream artifacts to downstream artifacts without gaps, contradictions, or unauthorized expansion.

## Upstream Dependencies

- All frozen upstream artifacts: PRD, ACF, SAD, DCF, TDD (and their frozen addendums)
- WDD (may be validated but not yet frozen)

## Traceability Checks

### 1. Requirement Coverage
**Rules**
- Every PRD functional requirement (FR-*) must map to at least one SAD component or responsibility
- Every PRD non-functional requirement (NFR-*) must be addressed in at least one SAD quality attribute or cross-cutting concern
- Any PRD requirement with no downstream trace is a "dropped_requirement"

**Failure Examples**
- FR-3 exists in PRD but no SAD component references it
- NFR-2 (performance) has no corresponding SAD quality attribute

### 2. Requirement-to-Work Traceability
**Rules**
- Every PRD functional requirement must trace through to at least one WDD work item
- Any FR with no WDD work item is a "dropped_requirement"
- Any WDD work item that cannot trace back to a PRD requirement is "phantom_scope"

**Failure Examples**
- FR-5 has a SAD component but no WDD work item implements it
- WDD-PROJ-015 exists but traces to no PRD requirement

### 3. Scope Containment
**Rules**
- No TDD interface, module, or component may exist without a corresponding SAD component
- No WDD work item may introduce scope not present in the TDD
- Violations are "phantom_scope"

**Failure Examples**
- TDD defines a "NotificationService" module with no corresponding SAD component
- WDD work item adds a caching layer not mentioned in the TDD

### 4. Non-Goal Enforcement
**Rules**
- Collect all non-goals from the PRD
- No SAD component, TDD interface, or WDD work item may contradict a stated non-goal
- Violations are "non_goal_violation"

**Failure Examples**
- PRD non-goal: "No real-time notifications" but WDD includes a WebSocket work item
- SAD component implements functionality explicitly excluded by PRD

### 5. Constraint Propagation
**Rules**
- Collect all constraints from the ACF (technology, compliance, operational)
- SAD, TDD, and WDD must not violate any ACF constraint
- Violations are "constraint_violation"

**Failure Examples**
- ACF requires "all data encrypted at rest" but TDD specifies unencrypted local storage
- ACF forbids direct database access but WDD work item bypasses the API layer

### 6. Interface Alignment
**Rules**
- SAD-declared integration points, protocols, and boundaries must align with TDD technical specifications
- Mismatches are "contradiction"

**Failure Examples**
- SAD declares REST API but TDD specifies gRPC for the same interface
- SAD boundary defines async messaging but TDD implements synchronous calls

### 7. Addendum Integration
**Rules**
- If addendums exist for any artifact, changes introduced by frozen addendums must be reflected in downstream artifacts
- Unintegrated addendum changes are "dropped_requirement"

**Failure Examples**
- PRD Addendum adds FR-10 but no downstream artifact references it
- SAD Addendum modifies a component boundary but TDD still reflects the original

## Inconsistency Types

| Type | Meaning |
|------|---------|
| `dropped_requirement` | Upstream requirement has no downstream trace |
| `phantom_scope` | Downstream artifact introduces scope not in upstream |
| `contradiction` | Downstream artifact contradicts upstream specification |
| `non_goal_violation` | Downstream artifact implements something excluded by non-goals |
| `constraint_violation` | Downstream artifact violates an ACF constraint |

## Completeness Rules

- All 7 traceability checks must be performed
- Missing downstream artifacts are warnings, not failures (the artifact may not yet exist)
- Implicit coverage is not coverage — if a link is not explicit, it is missing
- A traceability matrix must be built: PRD requirements → SAD components → TDD modules → WDD work items

## Relationship Rules

- Consistency checks evaluate cross-artifact relationships only (not individual artifact quality)
- Per-artifact quality is the responsibility of per-artifact validators
- The consistency check does not fix or redesign — it reports

## Hard Gates

### Consistency Report (generated by consistency prompt)
1. **requirement_coverage** — Every PRD requirement maps to at least one SAD component
2. **requirement_to_work** — Every functional requirement traces to at least one WDD work item
3. **scope_containment** — No downstream artifact introduces unauthorized scope
4. **non_goal_enforcement** — No downstream artifact contradicts stated non-goals
5. **constraint_propagation** — No downstream artifact violates ACF constraints
6. **interface_alignment** — SAD integration points match TDD specifications
7. **addendum_integration** — Frozen addendum changes reflected downstream

### Consistency Report Validation (evaluated by consistency validator)
All 7 checks above, plus:
8. **report_completeness** — Artifacts checked list populated, traceability matrix has non-zero totals, inconsistencies array present
